version: 2

models:
  - name: mart_advisory_decisions
    description: "Advisory decisions with rule-based state determinations"
    columns:
      - name: advisory_id
        description: "Unique advisory identifier (package:CVE)"
        tests:
          - unique
          - not_null
      - name: state
        description: "Advisory state (fixed, not_applicable, pending_upstream, etc.)"
        tests:
          - not_null
          - accepted_values:
              values: ['fixed', 'not_applicable', 'wont_fix', 'pending_upstream', 'under_investigation', 'unknown']
      - name: state_type
        description: "State type (final or non_final)"
        tests:
          - accepted_values:
              values: ['final', 'non_final']
      - name: decision_rule
        description: "Rule that determined this state"
        tests:
          - not_null
      - name: reason_code
        description: "Reason code for explanation template"
        tests:
          - not_null
      - name: confidence
        description: "Confidence level (high, medium, low)"
        tests:
          - accepted_values:
              values: ['high', 'medium', 'low']

  - name: mart_advisory_current
    description: |
      Current advisory states with human-readable explanations (PACKAGE-LEVEL GRANULARITY).
      This is the base mart that maintains package-level detail. Each CVE may appear
      multiple times if it affects multiple packages. For CVE-level aggregation,
      use mart_advisory_current_by_cve instead.
    columns:
      - name: advisory_id
        description: "Unique advisory identifier (package:CVE or CVE-only for NVD records)"
        tests:
          - unique
          - not_null
      - name: explanation
        description: "Human-readable explanation of the decision"
        tests:
          - not_null
      - name: state
        description: "Advisory state"
        tests:
          - not_null

  - name: mart_advisory_current_by_cve
    description: |
      CVE-level deduplicated view of current advisory states (ONE ROW PER CVE).
      Aggregates package-level advisories using "worst state wins" priority.
      Use this for reporting, dashboards, and simple CVE lookups.
      Use mart_advisory_current for package-level analysis and detailed triage.
    columns:
      - name: advisory_id
        description: "CVE identifier (unique, one row per CVE)"
        tests:
          - unique
          - not_null
      - name: cve_id
        description: "CVE identifier"
        tests:
          - not_null
      - name: affected_packages
        description: "List of all packages affected by this CVE"
      - name: package_count
        description: "Number of packages affected"
      - name: primary_package
        description: "Primary package used for state determination (highest priority)"
      - name: state
        description: "Advisory state (from highest priority package)"
        tests:
          - not_null
      - name: explanation_with_context
        description: "Explanation including multi-package context when applicable"
